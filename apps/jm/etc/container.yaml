# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices/configuration.html#application-related-configuration
parameters:
    mongo_database: 'job_manager'

services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: true

    App\Storage\JobStorage: '@yadm.job.storage'
    App\Storage\ProcessStorage: '@yadm.process.storage'
    App\Storage\ProcessExecutionStorage: '@yadm.process_execution.storage'

    Enqueue\Client\ProducerInterface:
        alias: 'enqueue.producer'

    formapro.pvm.process_execution_storage:
        autowire: false
        class: 'Formapro\Pvm\Yadm\MongoProcessStorage'
        arguments:
            - '@App\Storage\ProcessExecutionStorage'

    Formapro\Pvm\ProcessStorage: '@formapro.pvm.process_execution_storage'

    Formapro\Pvm\DefaultBehaviorRegistry: ~

    Formapro\Pvm\BehaviorRegistry: '@Formapro\Pvm\DefaultBehaviorRegistry'

    Formapro\Pvm\Enqueue\AsyncTransition: ~
    Formapro\Pvm\AsyncTransition: '@Formapro\Pvm\Enqueue\AsyncTransition'

    Formapro\Pvm\ProcessEngine:

    App\Infra\JsonSchema\LocalUriRetriver:
        autowire: false
        arguments:
            - '%kernel.root_dir%/../etc/schemas'
            - 'http://jm.forma-pro.com/schemas'

    JsonSchema\Uri\UriRetriever:
        autowire: false
        calls:
            - ['setUriRetriever', ['@App\Infra\JsonSchema\LocalUriRetriver']]

    JsonSchema\Constraints\Factory:
        autowire: false
        arguments:
            - ~
            - '@JsonSchema\Uri\UriRetriever'
            - 2 # JsonSchema\Constraints\Constraint::CHECK_MODE_TYPE_CAST

    App\Infra\JsonSchema\SchemaValidator: ~

    App\Async\Processor\:
        resource: '../src/Async/Processor/*'
        tags: ['enqueue.client.processor']

    App\Pvm\Behavior\:
        resource: '../src/Pvm/Behavior/*'
        tags: ['pvm.behavior']

    Formapro\Pvm\Enqueue\HandleAsyncTransitionProcessor:
        autowire: false
        arguments:
            - '@Formapro\Pvm\ProcessEngine'
            - '@formapro.pvm.process_execution_storage'
        tags: ['enqueue.client.processor']
